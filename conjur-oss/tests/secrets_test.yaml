suite: Test Secrets
templates:
  - "secrets.yaml"
tests:
  - it: should create an SSL cert for d/b access if no cert values provided
    set:
      dataKey: "1234567890"
      createDataKeySecret: true
      database:
        secrets:
          createDatabasePasswordSecrets: true
          password: "password"
    template: "secrets.yaml"
    documentIndex: 4
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-conjur-database-ssl
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install
      - matchRegex:
          path: data["tls.crt"]
          # Check that the first 500 chars are valid base64
          pattern: ^[A-Za-z0-9+/]{500,}={0,2}$

  - it: should use the 'database.url' if provided
    set:
      dataKey: "1234567890"
      createDataKeySecret: true
      database:
        secrets:
          createDatabasePasswordSecrets: true
          password: "password"
        url: "postgres://user:password@host:port/dbname"
    template: "secrets.yaml"
    documentIndex: 2
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-conjur-database-url
      - notExists:
          path: metadata.annotations["helm.sh/hook"]
      - equal:
          path: data["key"]
          value: "postgres://user:password@host:port/dbname"
          decodeBase64: true

  - it: should create data-key secret when createDataKeySecret is true
    set:
      dataKey: "1234567890"
      createDataKeySecret: true
      database:
        secrets:
          createDatabasePasswordSecrets: true
          password: "password"
    template: "secrets.yaml"
    documentIndex: 1
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-conjur-data-key
      - equal:
          path: data["key"]
          value: "1234567890"
          decodeBase64: true

  - it: should NOT create data-key secret when createDataKeySecret is false
    set:
      createDataKeySecret: false
      dataKeySecretName: "external-data-key"
      database:
        secrets:
          createDatabasePasswordSecrets: true
          password: "password"
    template: "secrets.yaml"
    asserts:
      - notMatchRegex:
          path: metadata.name
          pattern: ".*conjur-data-key$"

  - it: should NOT create database-url secret when createDatabasePasswordSecrets is false
    set:
      dataKey: "1234567890"
      createDataKeySecret: true
      database:
        secrets:
          createDatabasePasswordSecrets: false
          databaseUrlSecret: "external-db-url"
          databasePasswordSecret: "external-db-password"
    template: "secrets.yaml"
    asserts:
      - notMatchRegex:
          path: metadata.name
          pattern: ".*conjur-database-url$"

  - it: should NOT create database-password secret when createDatabasePasswordSecrets is false
    set:
      dataKey: "1234567890"
      createDataKeySecret: true
      database:
        secrets:
          createDatabasePasswordSecrets: false
          databaseUrlSecret: "external-db-url"
          databasePasswordSecret: "external-db-password"
    template: "secrets.yaml"
    asserts:
      - notMatchRegex:
          path: metadata.name
          pattern: ".*conjur-database-password$"
