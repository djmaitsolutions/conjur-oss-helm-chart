suite: Test Secrets
templates:
  - "secrets.yaml"
tests:
  - it: should create an SSL cert for d/b access if no cert values provided
    set:
      dataKey: "1234567890"
      database:
        password: "password"
    template: "secrets.yaml"
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-conjur-database-ssl
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: pre-install
      - matchRegex:
          path: data["tls.crt"]
          # Check that the first 500 chars are valid base64 (Go regex only supports upto 1000 chars BTW) and check that the last chars are 0, 1 or 2 '='
          pattern: ^[A-Za-z0-9+/]{500,}={0,2}$
  - it: should use the 'database.url' if provided
    set:
      dataKey: "1234567890"
      database:
        password: "password"
        url: "postgres://user:password@host:port/dbname"
    template: "secrets.yaml"
    documentSelector:
      path: metadata.name
      value: RELEASE-NAME-conjur-database-url
    asserts:
      - notExists:
          path: metadata.annotations["helm.sh/hook"]
      - equal:
          path: data["key"]
          value: "postgres://user:password@host:port/dbname"
          decodeBase64: true